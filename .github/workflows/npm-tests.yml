# ---------------------------------------------------------------------------------------
#   @parent     : github workflow
#   @desc       : test release
#   @author     : Aetherinox
#   @url        : https://github.com/Aetherinox
# ---------------------------------------------------------------------------------------

name: "📦 NPM › Tests"
run-name: "📦 NPM › Tests"

# ---------------------------------------------------------------------------------------
#   triggers
# ---------------------------------------------------------------------------------------

on:
  workflow_dispatch:

# ---------------------------------------------------------------------------------------
#   jobs
# ---------------------------------------------------------------------------------------

jobs:
    test:
        name: >-
          📦 Tests › Initialize
        runs-on: ubuntu-latest
        timeout-minutes: 60

        steps:
            - name: "✅ Start"
              id: task_test_start
              run: |
                echo "Starting build"

            # ---------------------------------------------------------------------------------------
            #   Job > Initialize > Checkout
            # ---------------------------------------------------------------------------------------

            - name: "☑️ Checkout"
              id: task_test_checkout
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            # ---------------------------------------------------------------------------------------
            #   Job > Use NodeJS
            # ---------------------------------------------------------------------------------------

            - name: "⚙️ Setup Node"
              id: task_test_node_setup
              uses: actions/setup-node@v4
              with:
                node-version: lts/*

            # ---------------------------------------------------------------------------------------
            #   Job > Npm > Install Dependencies
            # ---------------------------------------------------------------------------------------

            - name: "⚙️ Install Dependencies"
              id: task_test_npm_deps
              run: |
                npm ci
                npx playwright install --with-deps
                npm i -D electron-playwright-helpers

            # ---------------------------------------------------------------------------------------
            #   Job > Npm > Run Tests
            # ---------------------------------------------------------------------------------------

            - name: Run Playwright tests in a virtual X server env
              run: xvfb-run --auto-servernum npx playwright test

            # ---------------------------------------------------------------------------------------
            #   Job > Npm > Generate Report
            # ---------------------------------------------------------------------------------------

            - name: "⚙️ Generate Report"
              uses: actions/upload-artifact@v4
              if: always()
              with:
                name: playwright-report
                path: playwright-report/
                retention-days: 30

            # ---------------------------------------------------------------------------------------
            #   Job > Upload Screenshots
            # ---------------------------------------------------------------------------------------

            - name: "🔗 Upload Screenshot"
              uses: actions/upload-artifact@v4
              if: always()
              with:
                name: Screencap
                path: test-results/1.png
                retention-days: 30


